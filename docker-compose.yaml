services:
  rabbitmq:
      image: rabbitmq:3-management
      container_name: chatapp-rabbitmq
      ports:
        - "${RABBITMQ_PORT:-5672}:5672"
        - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
      environment:
        RABBITMQ_DEFAULT_USER: guest
        RABBITMQ_DEFAULT_PASS: guest
      volumes:
        - rabbitmq-data:/var/lib/rabbitmq
      networks:
        - chatapp-network
      healthcheck:
        test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
        interval: 30s
        timeout: 10s
        retries: 5
        start_period: 30s
  
  auth-db:
    image: mysql:8.0
    container_name: chatapp-auth-db
    environment:
      MYSQL_DATABASE: ${AUTH_DB_NAME:-chatapp_auth_service}
      MYSQL_USER: ${AUTH_DB_USER:-chatapp_auth_user}
      MYSQL_PASSWORD: ${AUTH_DB_PASSWORD:-chatapp_auth_password}
      MYSQL_ROOT_PASSWORD: ${AUTH_DB_ROOT_PASSWORD:-root_password}
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password"]
    ports:
      - "${AUTH_DB_PORT:-3306}:3306"
    volumes:
      - auth-db-data:/var/lib/mysql
    networks:
      - chatapp-network

volumes:
  auth-db-data:
  rabbitmq-data:


networks:
  chatapp-network:
    driver: bridge